---
title: "INFORME INTERACTIVO CALIBRACION"
author: "Oscar Garcia Hernandez"
date: "21/5/2019"
output:html_document: 
   
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      eval=FALSE,
                      warning = FALSE,
                      fig.align = "center",
                      message = FALSE)
library(request) 
library(XML)
library(here)
library(lubridate)
library(stringr)
library(dplyr)
library(TTR)
library(shiny)
library(ggplot2)
library(magrittr)
library(OpenStreetMap)
library(RColorBrewer)
library(geosphere)
library(data.table)
library(reshape)
library(reshape2)
library(MASS)
```

```{r}
source(here::here('NUEVO/Libraries.R'))
```

```{r eval=TRUE}
download_maps<- function(ul,lr, 
                         maptyp=NULL,
                         res=40){
  
  #SI NO INTRODUCIMOS TIPO DE MAPA SE DESCARGAN LOS SIGUIENTES MAPAS
  if(is.character(maptyp)){
    maptypes<- maptyp
  }else{
    maptypes<- c("waze", "bing",
                 "esri","esri-topo", "nps", 
                 "apple-iphoto", "skobbler",
                 "hillshade")
  }
  
  
  if(length(maptypes)>1){
    res1<- res
    for (i in 1:length(maptypes)) {
      res<- res1
      
      
      tryCatch({
        while(TRUE){
          tryCatch({
            map1<- openmap(ul,lr, minNumTiles=res,
                           type=maptypes[i],
                           zoom=NULL)
            
          },error=function(e){cat("Error Java")})
          
          if(!exists("map1")){
            res<- res-1
            print("Bajando minNumtiles")
            if(res<1){break}
          }else{
            print(paste0(maptypes[i],": Descargado con minNumtiles=", res))
            break}
        }
        map.latlon <- openproj(map1, projection = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
        rm(map1)
       
        if(!dir.exists(here::here("NUEVO/Mapas/"))){dir.create(here::here("NUEVO/Mapas/"))}
        dirpath<- here::here(paste0("NUEVO/Mapas/",ul[1],"_",lr[2],"/"))
        
        if(!dir.exists(dirpath)){dir.create(dirpath)}
        
        saveRDS(map.latlon, file=paste0(dirpath,"/",maptypes[i],res,".RDS"))
        print(paste0("Guardado ",paste0(dirpath,"/",maptypes[i],res,".RDS")))
        rm(map1) 
          
       
      }, error=function(e){print(paste0(maptypes[i],": No descargado"))})
    }
    
  }else{
    while(TRUE){
      tryCatch({
        #INTENTAMOS DESCARGAR MAPA Y SI HAY FALLO BAJAMOS LA RESOLUCION Y VOLVEMOS A INTENTAR
        map1<- openmap(ul,lr, minNumTiles=res,
                      type=maptypes,
                      zoom=NULL)
        
      },error=function(e){cat("Error Java")})
      
      
      if(!exists("map1")){
        res<- res-1
        print("Bajando minNumtiles")
        if(res<1){break}
      }else{
        print(paste0(maptypes,": Descargado con minNumtiles=", res))
        break}
    }
    
    #TRANSFORMACION DE COORDEANDAS PARA TENERLO EN FORMATO "NORMAL"
    map.latlon <- openproj(map1, projection = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
    rm(map1)
    
    
    #CREAMOS DIRECTORIO
    dir_raiz<- here::here("Mapas/")
    dirpath<- paste0(dir_raiz,ul[1],"_",lr[2],"/")
    
    if(!dir.exists(dirpath)){dir.create(dirpath, recursive = T)}
    
    #GUARDAMOS MAPA
    saveRDS(map.latlon, file=paste0(dirpath,"/",maptypes,res,".RDS"))
    return(paste0(dirpath,"/",maptypes,res,".RDS"))
      
    }
    
}




plot.windrose <- function(data,
                          spd,
                          dir,
                          spdres = 0.5,
                          dirres = 22.5,
                          spdmin = 0,
                          spdmax = 15,
                          spdseq = NULL,
                          palette,
                          countmax = NA,
                          opacity=0.6,
                          border_color="NA",
                          border_size=0.001){
  
  
  # Look to see what data was passed in to the function
  if (is.numeric(spd) & is.numeric(dir)){
    # assume that we've been given vectors of the speed and direction vectors
    data <- data.frame(spd = spd,
                       dir = dir)
    spd = "spd"
    dir = "dir"
  }
  # Tidy up input data ----
  n.in <- NROW(data)
  dnu <- (is.na(data[[spd]]) | is.na(data[[dir]]))
  data[[spd]][dnu] <- NA
  data[[dir]][dnu] <- NA
  data<-data[,c(spd,dir)]
  
  # figure out the wind speed bins ----
  if (missing(spdseq)){
    spdseq <- seq(spdmin,spdmax,spdres)
  } 
  # get some information about the number of bins, etc.
  n.spd.seq <- length(spdseq)
  n.colors.in.range <- n.spd.seq - 1
  
  # create the color map
  spd.colors <- colorRampPalette(brewer.pal(min(max(3,n.colors.in.range),
                                                min(9,n.colors.in.range)),
                                            palette ))(n.colors.in.range)
  
  if (max(data[[spd]],na.rm = TRUE) > spdmax){    
    spd.breaks <- c(spdseq,
                    max(data[[spd]],na.rm = TRUE))
    spd.labels <- c(paste(c(spdseq[1:n.spd.seq-1]),
                          '-',
                          c(spdseq[2:n.spd.seq])),
                    paste(spdmax,
                          "-",
                          max(data[[spd]],na.rm = TRUE)))
    spd.colors <- c(spd.colors, "grey50")
  } else{
    spd.breaks <- spdseq
    spd.labels <- paste(c(spdseq[1:n.spd.seq-1]),
                        '-',
                        c(spdseq[2:n.spd.seq]))    
  }
  data$spd.binned <- cut(x = data[[spd]],
                         breaks = spd.breaks,
                         labels = spd.labels,
                         ordered_result = TRUE)
  # clean up the data
  data <- na.omit(data)
  
  # figure out the wind direction bins
  dir.breaks <- c(-dirres/2,
                  seq(dirres/2, 360-dirres/2, by = dirres),
                  360+dirres/2)  
  dir.labels <- c(paste(360-dirres/2,"-",dirres/2),
                  paste(seq(dirres/2, 360-3*dirres/2, by = dirres),
                        "-",
                        seq(3*dirres/2, 360-dirres/2, by = dirres)),
                  paste(360-dirres/2,"-",dirres/2))
  # assign each wind direction to a bin
  dir.binned <- cut(data[[dir]],
                    breaks = dir.breaks,
                    ordered_result = TRUE)
  levels(dir.binned) <- dir.labels
  data$dir.binned <- dir.binned
  
  
  
  # deal with change in ordering introduced somewhere around version 2.2
  if(packageVersion("ggplot2") > "2.2"){    
    cat("ggplot2 version > V2.2")
    data$spd.binned = with(data, factor(spd.binned, levels = rev(levels(spd.binned))))
    spd.colors = rev(spd.colors)
  }
  
  # create the plot ----
  p.windrose <- ggplot(data = data,
                       aes(x = dir.binned,
                           fill = spd.binned)) +
    geom_bar(width = 1,color=border_color, size=border_size, alpha=opacity) + 
    scale_x_discrete(drop = FALSE,
                     labels = waiver()) + 
    theme(legend.position = "none",
          plot.background = element_rect(fill= "transparent", colour= NA),
          panel.background = element_rect(fill= "transparent", colour = NA),
          panel.grid.major = element_line(colour = "NA"), 
          axis.line = element_line(colour = NA),
          axis.text.y=element_blank(), 
          axis.ticks.y = element_blank(), 
          axis.text.x = element_blank()) +
    xlab("")+ ylab("") +
    coord_polar(start = -((dirres/2)/360) * 2*pi)+
    scale_fill_manual(name = "Wind Speed (m/s)", 
                      values = spd.colors,
                      drop = FALSE)
  
  # adjust axes if required
  if (!is.na(countmax)){
    p.windrose <- p.windrose +
      ylim(c(0,countmax))
  }
  
  # print the plot
  print(p.windrose)  
  
  # return the handle to the wind rose
  return(p.windrose)
}

WR_parameters2<- function(data,
                         anchura=0.06, 
                         opacidad=0.5, 
                         paleta,
                         lon_pos,
                         lat_pos,
                         spd_name,
                         dir_name,
                         border_size=0.5){
  p_ros<-data %>% group_by(., lon,lat)%>% do(subplots = plot.windrose(., spd = spd_name,
                                    dir=dir_name,
                                    dirres = 22.5,
                                    spdseq= c(0,0.3,1,2,3,5,7,10,15,20),
                                    palette = paleta,
                                    opacity = opacidad,
                                    border_color = "white",
                                    border_size = border_size)) %>%
  mutate(subgrobs = list(annotation_custom(ggplotGrob(subplots),
                                           x = lon_pos-anchura,      # change from 1 to other 
                                           y = lat_pos-anchura,      # values if necessary,
                                           xmax = lon_pos+anchura,   # depending on the map's
                                           ymax = lat_pos+anchura))) # resolution.


  
  return(p_ros)
}


#A LA FUNCION DE WEIBULL PLOT HAY QUE METER UN DATAFRAME QUE CONTENGA 
# COLUMNA ERAWS= velocidad del viento era
# COLUMNA WS_N= velocidad del viento anemo

#POR DEFECTO DEVUELVE LA ACUMULADA Y LA DISTRIBUIDA... SE PUEDEN PONER A FALSE
# CUALQUIERA DE LOS DOS

#PRIMERO DEFINIMOS FUNCIONES B√ÅSICAS
fitweibull <- function(column, bind_anch) {
  x <- seq(0,10,by=bind_anch)
  fitparam <- column %>%
    fitdistr(densfun=dweibull,start=list(scale=1,shape=2))
  return(dweibull(x, scale=fitparam$estimate[1], shape=fitparam$estimate[2]))
}

  cdweibull <- function(column, bind_anch) {
  x <- seq(0,10,by=bind_anch)
  fitparam <- column %>%
    fitdistr(densfun=dweibull,start=list(scale=1,shape=1))
  dd<- dweibull(x, scale=fitparam$estimate[1], shape=fitparam$estimate[2])
  dd <- cumsum(dd) * c(0, diff(x))
  return(dd)
}


WEIBULL_PLOT<- function(DATOS_INPUT, ACUMULATED= TRUE, 
                        DISTRIBUTION= TRUE, 
                        CALIBRATED= FALSE, 
                        TOTAL_VECTOR= NULL){

bind_anch_dist<- 0.25
bind_anch_acum<- 0.01
bind_width<- 0.25


DATOS_weibull<- DATOS_INPUT %>% .[complete.cases(.), ] 
DATOS_weibull$WS_N<- ifelse(DATOS_weibull$WS_N==0,NA,DATOS_weibull$WS_N) 
DATOS_weibull$ERAWS<- ifelse(DATOS_weibull$ERAWS==0,NA,DATOS_weibull$ERAWS) 

DATOS_weibull<- DATOS_weibull %>% .[complete.cases(.), ]

DIST_WEIBULL_p<- ggplot() + 
  geom_histogram(data= DATOS_weibull, 
                 aes(x=ERAWS),
                 binwidth = bind_anch_dist) +
  geom_histogram(data=DATOS_weibull,
                 aes(x=WS_N),
                 binwidth = bind_anch_dist)+
  geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                y=fitweibull(DATOS_weibull$ERAWS, bind_anch_dist)))+
  geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                y=fitweibull(DATOS_weibull$WS_N, bind_anch_dist)))


x<- ggplot_build(DIST_WEIBULL_p)
dist_count_maxERA<- x$data[[1]]$count %>% max()
dist_count_maxA <-x$data[[2]]$count %>% max()
shape_factorERA<- (dist_count_maxERA)/x$data[[3]]$y %>% max()
shape_factorA<- (dist_count_maxA)/x$data[[4]]$y %>% max()




ACUM_WEIBULL_p<- ggplot() + 
  geom_histogram(data= DATOS_weibull, 
                 aes(x=ERAWS),
                 binwidth = bind_width)+
  geom_histogram(data=DATOS_weibull,
                 aes(x=WS_N),
                 binwidth = bind_width)+
  geom_line(aes(x=seq(0,10,by=bind_anch_acum),
                y=cdweibull(DATOS_weibull$ERAWS, bind_anch_acum)))+
  geom_line(aes(x=seq(0,10,by=bind_anch_acum),
                y=cdweibull(DATOS_weibull$WS_N, bind_anch_acum)))

x<- ggplot_build(ACUM_WEIBULL_p)
count_max<- c(x$data[[1]]$count %>% max(),x$data[[2]]$count %>% max()) %>% max()
dens_max<- c(x$data[[3]]$y %>% max(),x$data[[4]]$y %>% max()) %>% max()
shape_factor_acum<- count_max/dens_max




DIST_WEIBULL<- ggplot() + 
  geom_histogram(data= DATOS_weibull, 
                 aes(x=ERAWS),
                 binwidth = bind_anch_dist,
                 alpha=0.4,
                 fill="red")+
  geom_histogram(data=DATOS_weibull,
                 aes(x=WS_N),
                 binwidth = bind_anch_dist,
                 alpha=0.4,
                 fill="blue")+
  geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                y=fitweibull(DATOS_weibull$ERAWS, bind_anch_dist)*shape_factorERA), col="darkred")+
  geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                y=fitweibull(DATOS_weibull$WS_N, bind_anch_dist)*shape_factorA), col="darkblue")+
  ylab("")+
  xlab("Wind Speed [m/s]")+
  labs(title = element_text("Speed distribution and Weibull fit", hjust = 0.5))+
  theme_light()




ACUM_WEIBULL<- ggplot() + 
  geom_histogram(data= DATOS_weibull, 
                 aes(x=ERAWS),
                 binwidth = bind_width,
                 alpha=0.4,
                 fill="red")+
  geom_histogram(data=DATOS_weibull,
                 aes(x=WS_N),
                 binwidth = bind_width,
                 alpha=0.4,
                 fill="blue")+
  geom_line(aes(x=seq(0,10,by=bind_anch_acum),
                y=cdweibull(DATOS_weibull$ERAWS, bind_anch_acum)*shape_factor_acum), col="darkred")+
  geom_line(aes(x=seq(0,10,by=bind_anch_acum),
                y=cdweibull(DATOS_weibull$WS_N, bind_anch_acum)*shape_factor_acum), col="darkblue")+
  ylab("")+
  xlab("Wind Speed [m/s]")+
  labs(title = element_text("Acumulated weibull distribution", hjust = 0.5))+
  theme_light()

if(CALIBRATED){
  
  DATOS_weibull$CALIB<- ifelse(DATOS_weibull$CALIB==0,NA,DATOS_weibull$CALIB)
  DATOS_weibull<- DATOS_weibull %>% .[complete.cases(.),]
  DIST_WEIBULL<- DIST_WEIBULL + geom_histogram(data=DATOS_weibull,
                                               aes(x=CALIB),
                                               binwidth = bind_anch_dist,
                                               alpha=0.4,
                                               fill="green")+ 
    geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                  y=fitweibull(DATOS_weibull$CALIB,
                               bind_anch_dist)*shape_factorERA),
              col="darkgreen")
  

  ACUM_WEIBULL<- ACUM_WEIBULL + 
geom_histogram(data=DATOS_weibull,
                 aes(x=CALIB),
                 binwidth = bind_width,
                 alpha=0.4,
                 fill="green")+
  geom_line(aes(x=seq(0,10,by=bind_anch_acum),
                y=cdweibull(DATOS_weibull$CALIB, bind_anch_acum)*shape_factor_acum), col="darkgreen")
  
}
if(!is.null(TOTAL_VECTOR)){
  TOTAL_VECTOR<- ifelse(TOTAL_VECTOR==0,NA,TOTAL_VECTOR)
  TOTAL_VEC<- TOTAL_VECTOR %>% na.omit()
  count_ERA<- ggplot() + geom_histogram(aes(x=TOTAL_VEC),
                                               binwidth = bind_anch_dist) +
    
    geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                  y=fitweibull(TOTAL_VEC,
                               bind_anch_dist)))
  list_grapht<- ggplot_build(count_ERA)
  count_ERA_max<- list_grapht %>% .$data %>% .[[1]] %>% .$count %>% max()
  dist_ERA_max<- list_grapht %>% .$data %>% .[[2]] %>% .$y %>% max()
  
  max_count<- c(dist_count_maxA, dist_count_maxERA) %>% max()
  
  multiplier_counts<- max_count/count_ERA_max
  shape_total<- max_count/dist_ERA_max
  
  

  
  DIST_WEIBULL<- DIST_WEIBULL + geom_bar(aes(y=multiplier_counts*(ggplot_build(count_ERA) %>% 
                                                                    .$data %>% .[[1]] %>% 
                                                                    .$count),
                                             x = ggplot_build(count_ERA) %>% 
                                               .$data %>% .[[1]] %>% .$x),
                                         stat = "identity",
                                         alpha=0.4,
                                         fill="orange")+ 
    geom_line(aes(x=seq(0,10,by=bind_anch_dist),
                  y=fitweibull(TOTAL_VEC,
                               bind_anch_dist)*shape_total),
              col="darkorange")
  

  ACUM_WEIBULL<- ACUM_WEIBULL +
  geom_line(aes(x=seq(0,10,by=bind_anch_acum),
                y=cdweibull(TOTAL_VEC, bind_anch_acum)*shape_factor_acum), col="darkorange")
  
}






  if(ACUMULATED & DISTRIBUTION){
    print(list(DIST_WEIBULL, ACUM_WEIBULL))
  }else{
    if (ACUMULATED) {print(ACUM_WEIBULL)}
    if (DISTRIBUTION) {print(DIST_WEIBULL)}
  }
return(DATOS_weibull)
} 

```

# GR√ÅFICO INTERACTVIVO 

Sin miedo, este gr√°fico interactivo tiene el prop√≥sito de permitirnos interactuar con nuestros datos, como una manera de poder entender mejor como se comportan. Despu√©s se ir√°n presentando los resultados previos a la calibraci√≥n del bias. Empleando diferentes m√©todos. 

```{r echo=FALSE, eval=TRUE}
### CARGAMOS DATOS
DATA_FOLDERS<- list.dirs(here::here('NUEVO/Data_calibracion/'), recursive = F)

ERA5_FILES<-  DATA_FOLDERS[1] %>% list.files(full.names = T) %>% 
  .[str_detect(., "ERA5")]

DATES_FILES<- ERA5_FILES %>% sapply(function(x){
  filename<- str_split(x, '/') %>% .[[1]] %>% .[length(.)]
  date_filename<- str_replace(filename, 'ERA5_', '') %>% str_replace(. , '.RDS','') %>% ymd()
  date_filename
})


DATOS_JUNTOS<- ERA5_FILES[which.max(DATES_FILES)] %>% readRDS()


DATOS_JUNTOS_LISTA<- DATOS_JUNTOS %>% group_split(ERAlon,ERAlat)

Tabla_dist<- DATOS_JUNTOS_LISTA %>% lapply(function(x){y<- cbind(x$ERAlon %>% unique, x$ERAlat %>% unique()) %>% as.data.frame(); colnames(y)<- c("lon","lat"); return(y)}) %>% sapply(., function(x){
  distm(x, c(DATOS_JUNTOS_LISTA[[1]]$lon %>% unique,
             DATOS_JUNTOS_LISTA[[1]]$lat %>% unique))
}) 

DATOS_PLOT<- DATOS_JUNTOS_LISTA[[which.min(Tabla_dist)]] %>%
  mutate(ERA_binDir= cut(ERAWD ,
                         breaks =c(0,seq(22.5,337.5,22.5),360, 361), 
                         labels = c(0,seq(22.5,337.5,22.5),0) %>% as.factor()))
DATOS_PLOT$ERA_binDir<- DATOS_PLOT$ERA_binDir %>% as.character() %>% as.numeric()
West<- c(247.5, 270.0, 292.5)
North_west<-c(292.5,315.0,337.5)
South_west<- c(202.5, 225.0, 247.5)
North<- c(0.0,22.5,337.5)
North_east<- c(22.5,45.0,67.5)
East<- c(67.5,90,112.5)
South_east<- c(112.5,135.0,157.5)
South<- c(155.0,180.0, 202.5)

#################A PARTIR DE AQUI, SHINY

inputPanel(
  selectInput("Interpolation", 
              label = "Fit ERA method",
              choices = c("linear", "spline", "stine", "Nearest"),
              selected = "Nearest"),
  
  checkboxInput("GUST",
                label = "MAXIMAS ANEMOMETRO",
                value = TRUE),
  
  
  dateRangeInput("Date_range",
                      label = "Periodo",
                 start =DATOS_JUNTOS_LISTA[[1]] %>%
                        as.data.frame() %>% 
                        .$Date %>% min(),
                 end = DATOS_JUNTOS_LISTA[[1]] %>%
                        as.data.frame() %>% 
                        .$Date %>% max()),
  
    sliderInput("SMA_value", label = "Valores de MA en horas",
              min =1,
              max = 144,
              step = 2,
              value =1 ),
  selectInput("filter",
                "¬øFiltrado por direccionies?",
              choices = c("Direcciones anemometro",
                          "Direcciones ERA5",
                          "Nada"),
              selected = "Nada"),

  
        selectInput("SELECTOR", 
              label = "Tipo de Gr√°fica",
              choices = c("Comparativa", 
                          "Cross-correlation", 
                          "Rosa de los vientos"),
              selected = "Comparativa"))


conditionalPanel('!(input.filter=="Nada")',
             checkboxInput("NSWE", 
              label = "¬øAgrupar direcciones?",
              value = FALSE))

conditionalPanel('!(input.filter=="Nada")',conditionalPanel('!input.NSWE',
             selectInput("filtrado_anemo", 
              label = "Filtrado por direccion del anemometro",
              choices = DATOS_PLOT$WD_N %>% unique() %>% as.character() ,
              selected = "247.5")))
conditionalPanel('input.NSWE',
             selectInput("filtrado_anemo_agrup", 
              label = "Filtrado por direccion del anemometro",
              choices = c("N", "NW","NE","S","SW", "SE","W", "E"),
              selected = "N"))

conditionalPanel('input.SELECTOR=="Cross-correlation"',
            selectInput("type_corr", 
              label = "Metodo comparativo",
              choices = c("correlation", "covariance"),
              selected = "correlation"))


   plotData <- reactive({
     x<- DATOS_PLOT %>% .[complete.cases(.),] %>%  mutate(ERAWS=SMA(ERAWS, input$SMA_value),
                                     WS_l=SMA(WS_l, input$SMA_value),
                                     WS_sp=SMA(WS_sp, input$SMA_value),
                                     WS_N=SMA(WS_N, input$SMA_value),
                                     WS_st=SMA(WS_st, input$SMA_value),
                                     WSMAX_l=SMA(WSMAX_l, input$SMA_value),
                                     WSMAX_sp=SMA(WSMAX_sp, input$SMA_value),
                                     WSMAX_N=SMA(WSMAX_N, input$SMA_value),
                                     WSMAX_st=SMA(WSMAX_st, input$SMA_value)) %>%
  filter(. , Date>ymd(input$Date_range[1])) %>% 
  filter(. , Date<ymd(input$Date_range[2])) %>% 
  mutate(ANEM_selected= ifelse(rep(input$Interpolation=="linear",nrow(.)),WS_l,
                               ifelse(rep(input$Interpolation=="spline",nrow(.)), WS_sp,
                                      ifelse(rep(input$Interpolation=="stine",nrow(.)), WS_st,
                                             ifelse(rep(input$Interpolation=="Nearest",nrow(.)), WS_N,NA)))))
y<-x
if(!input$filter=="Nada"){
  if(input$filter=="Direcciones anemometro"){
    if(!input$NSWE){
   x<- x %>% filter(WD_N==input$filtrado_anemo %>% as.numeric())
   x
   }else{
    
      x<- x %>% filter(WD_N%in%ifelse(rep(input$filtrado_anemo_agrup=="N",3),
                                   North,ifelse(rep(input$filtrado_anemo_agrup=="E",3),
                                          East,ifelse(rep(input$filtrado_anemo_agrup=="S",3),
                                                      South,
                                                      ifelse(rep(input$filtrado_anemo_agrup=="W",3),
                                                             West,
                                                             ifelse(rep(input$filtrado_anemo_agrup=="NW",3),
                                                                    North_west,
                                                                    ifelse(rep(input$filtrado_anemo_agrup=="NE",3),
                                                                    North_east,
                                                                    ifelse(rep(input$filtrado_anemo_agrup=="SW",3),
                                                                    South_west,
                                                                    ifelse(rep(input$filtrado_anemo_agrup=="SE",3),
                                                                    South_east,NA)))))))))
   x
 }
  }else{
        if(!input$NSWE){
   x<- x %>% filter(ERA_binDir==input$filtrado_anemo %>% as.numeric())
   x
   }else{
    
   x<- x %>% filter(ERA_binDir%in%ifelse(rep(input$filtrado_anemo_agrup=="N",3),
                                   North,ifelse(rep(input$filtrado_anemo_agrup=="E",3),
                                          East,ifelse(rep(input$filtrado_anemo_agrup=="S",3),
                                                      South,
                                                      ifelse(rep(input$filtrado_anemo_agrup=="W",3),
                                                             West,
                                                             ifelse(rep(input$filtrado_anemo_agrup=="NW",3),
                                                                    North_west,
                                                                    ifelse(rep(input$filtrado_anemo_agrup=="NE",3),
                                                                    North_east,
                                                                    ifelse(rep(input$filtrado_anemo_agrup=="SW",3),
                                                                    South_west,
                                                                    ifelse(rep(input$filtrado_anemo_agrup=="SE",3),
                                                                    South_east,NA)))))))))
   x
 }

  }
   
}else{}

 if(input$GUST){
    x<- x %>% mutate(GUST= ifelse(rep(input$Interpolation=="linear",nrow(.)),WSMAX_l,
                         ifelse(rep(input$Interpolation=="spline",nrow(.)), WSMAX_sp,
                                ifelse(rep(input$Interpolation=="stine",nrow(.)), WSMAX_st,
                                       ifelse(rep(input$Interpolation=="Nearest",nrow(.)), WSMAX_N,NA))))); x
   
 }
 else{
   x$GUST<- x$ANEM_selected
   x}
      
     
   })




 conditionalPanel('input.SELECTOR=="Comparativa"',
  renderPlot({

plotData() %>% 
  ggplot(aes(x=Date)) + 
  geom_line(aes(y=ERAWS), 
            size=1.2,
            color="blue")+
  geom_text(aes(x=Date,y=8,
                               angle=(-ERA_binDir+90)+180, 
                               label="‚Üí"), 
            color="blue", 
            alpha=0.5,
            size=15)+
  geom_line(aes(y=ANEM_selected),
            size=1.2, color="red")+
  geom_line(aes(y=GUST),
            size=0.6, 
            color="red",
            linetype="longdash", 
            alpha=0.6)+
  geom_text(aes(x=Date,y=6,
                angle=(-WD_N+90)+180, 
                label="‚Üí"),
            color="red", 
            alpha=0.5,
            size=15)+
  ylim(0,10)+theme(panel.background = element_blank(),
                   panel.border = element_rect(linetype = "dashed", fill = NA),
                   panel.grid.major = element_line(colour = "grey50"),
                   axis.text = element_text(size=20,face="bold"),
                   axis.title = element_text(size = 25, face="bold"))+
  labs(y= "Wind speed (m/s)",
       x= "")



}))
 
 
 conditionalPanel('input.SELECTOR=="Cross-correlation"',
                 renderPlot({
                  DATOS_modify<- plotData()
                   cross_corr<- ccf(DATOS_modify$ERAWS,
                       DATOS_modify$ANEM_selected, 
                       na.action = na.pass,
                       type=input$type_corr,
                       lag.max = 500,
                       plot = F)
                   
                   ccf(DATOS_modify$ERAWS,
                       DATOS_modify$ANEM_selected, 
                       na.action = na.pass,
                       type=input$type_corr,
                       main=paste("MAX VALUE=",round(max(cross_corr$acf, na.rm = T), 3),"\nDESFASE=",
                                  cross_corr$lag[which.max(cross_corr$acf)]),
                       xlab="LAG (Horas)",
                       ylab=input$type_corr,
                       lag.max = 500)
                 }))


  conditionalPanel('input.SELECTOR=="Rosa de los vientos"',
                   renderPlot({
DATOS_modify<- plotData()

#POSICION DE LA ROSA DE LOS VIENTOS
TIPO_MAPA<- "bing"
resolucion<- 40


#PARAMETROS PARA DESCARGAR MAPA. 

#SI SOLO REPRESENTAMOS UNA ROSA N=S Y E=W
n<- max(DATOS_modify$ERAlat %>% unique,
        DATOS_modify$lat)
s<- min(DATOS_modify$ERAlat %>% unique,
        DATOS_modify$lat)

e<- max(DATOS_modify$ERAlon %>% unique,
        DATOS_modify$lon)
w<- min(DATOS_modify$ERAlon %>% unique,
        DATOS_modify$lon)

#A√ëADIMOS UN INCREMENTO AL REDEDOR DEL MAPA QUE VAMOS A REPRESENTAR
incr_lat<- abs(DATOS_modify$ERAlat %>% unique - DATOS_modify$lat %>% unique())
incr_lon<- abs(DATOS_modify$ERAlon %>% unique - DATOS_modify$lon %>% unique())
incr<- max(c(incr_lat,incr_lon))

if(n > 0){n<- n + incr}else{n<- n + incr}
if(s > 0){s<- s - incr}else{s<- s- incr}
if(e > 0){e<- e + incr}else{e<- e + incr}
if(w > 0){w<- w - incr}else{w<- w- incr}


#REDONDEAMOS Y MONTAMOS UL Y LR
ul <- round(c(n,w),digits = 2)  #Upper Left
lr <- round(c(s,e), digits = 2)  #Lower Right


dir_raiz<- here::here("Mapas/")
dirpath<- paste0(dir_raiz,ul[1],"_",lr[2],"/")
    
  
  if(!file.exists(paste0(dirpath,"/",TIPO_MAPA,resolucion,".RDS"))){
    PATH_MAPA<- download_maps(ul,lr, 
                res=resolucion, 
                maptyp = TIPO_MAPA)
    mapa<- readRDS(PATH_MAPA)
    }else{
    mapa<- readRDS(paste0(dirpath,"/",TIPO_MAPA,resolucion,".RDS"))}
  #DESCARGAMOS MAPA "bing" (IMAGEN SATELITE)


#REPRESENTAMOS MAPA A PELO, SIN EJES NI NADA ELEMENT_BLANK FTW
pmap<- autoplot(mapa)+ 
  theme(axis.line=element_blank(),
        axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.position="none",
        panel.background=element_blank(),
        panel.border=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank())


#REPRESENTAMOS ROSA
p_rosERA<- WR_parameters2(data = DATOS_modify, 
                      anchura = incr, 
                      paleta = "YlGnBu",
                      opacidad = 0.5, 
                      lon_pos = DATOS_modify$ERAlon %>% unique(), 
                      lat_pos = DATOS_modify$ERAlat %>% unique(), 
                      spd_name = "ERAWS",
                      dir_name = "ERA_binDir",
                      border_size = 0.1)

p_rosANEM<- WR_parameters2(data = DATOS_modify, 
                      anchura = incr, 
                      paleta = "YlGnBu",
                      opacidad = 0.5, 
                      lon_pos = DATOS_modify$lon %>% unique(), 
                      lat_pos = DATOS_modify$lat %>% unique(), 
                      spd_name = "ANEM_selected",
                      dir_name = "WD_N",
                      border_size = 0.1)


pmap+p_rosERA$subgrobs+p_rosANEM$subgrobs
                     
                   }, width = 1000, height = 1000)

)
 
```

# Conclusiones preliminares. 

Tras bastante cacharrear se aprecia que realizando un filtrado de los datos por direcciones del anemometro se consigue aumentar la correlaci√≥n filtrando por las direcciones Este-SurEste, que resulta que adem√°s son las direcciones que mayor n√∫mero de datos tienen. ¬øCasualidad?, no lo creo. Adem√°s, a√±adiendo el factor del moving average (media m√≥vil) se logra aumentar considerablemente los resultados de correlaci√≥n. En cuanto a la manera de interpolar... llego a la conclusi√≥n que no se consiguen mejores resultados empleando "stine" o "spline", la √∫nica interpolaci√≥n que tienen sentido entre las elegidas es la interpolaci√≥n lineal, que, en algunos casos logra mejorar incluso la correlaci√≥n. 

Ya hemos visto que los datos hablando de modulo son muy satisfactorios. Pero aun falta entender la relaci√≥n que existe con las direcciones.
Una de las conclusiones preliminares hablando de correlacion en las direcciones es que sa puede apreciar es que cuando el anem√≥metro experimenta direcci√≥n Este-Sureste-Noreste ERA5 si que est√° captando bien esa tendencia. 

Esto √∫ltimo es interesante a la hora de realizar la correci√≥n.

# Weibull 

A continuaci√≥n se presentan las gr√°ficas de distrubuci√≥n de velocidades y su correspondiente ajuste con weibull. Esto nos servir√° para ver como mejora el bias la t√©cnica de quantile-mapping.

```{r eval=TRUE, results='hide',fig.keep='all'}

DATA_FOLDERS<- list.dirs(here::here('NUEVO/Data_calibracion/'), recursive = F)

ERA5_FILES<-  DATA_FOLDERS[1] %>% list.files(full.names = T) %>% 
  .[str_detect(., "ERA5")]

DATES_FILES<- ERA5_FILES %>% sapply(function(x){
  filename<- str_split(x, '/') %>% .[[1]] %>% .[length(.)]
  date_filename<- str_replace(filename, 'ERA5_', '') %>% str_replace(. , '.RDS','') %>% ymd()
  date_filename
})


DATOS_JUNTOS<- ERA5_FILES[which.max(DATES_FILES)] %>% readRDS()


DATOS_JUNTOS_LISTA<- DATOS_JUNTOS %>% group_split(ERAlon,ERAlat)
#PLOTEOS PARA COMPROBAR SIMILITUD ENTRE ERA5 Y ANEMOMETRO

Tabla_dist<- DATOS_JUNTOS_LISTA %>% lapply(function(x){y<- cbind(x$ERAlon %>% unique, x$ERAlat %>% unique()) %>% as.data.frame(); colnames(y)<- c("lon","lat"); return(y)}) %>% sapply(., function(x){
  distm(x, c(DATOS_JUNTOS_LISTA[[1]]$lon %>% unique,
             DATOS_JUNTOS_LISTA[[1]]$lat %>% unique))
}) 

DATOS_PLOT<- DATOS_JUNTOS_LISTA[[which.min(Tabla_dist)]] %>%
  mutate(ERA_binDir= cut(ERAWD ,
                         breaks =c(0,seq(22.5,337.5,22.5),360, 361), 
                         labels = c(0,seq(22.5,337.5,22.5),0) %>% as.factor()))
DATOS_PLOT$ERA_binDir<- DATOS_PLOT$ERA_binDir %>% as.character() %>% as.numeric()
DATOS_PLOT$WD_N<- ifelse(DATOS_PLOT$WD_N==155, 157.5, DATOS_PLOT$WD_N) 


#ANTES DE TAYLOR VAMOS A HACER WEIBULL

WEIBULL_PLOT(DATOS_INPUT =DATOS_PLOT)


```


# DIAGRAMAS DE TAYLOR

A continuaci√≥n se presentan los diagramas de taylor empleando diferentes estrat√©gias. esto nos permite ver en un solo gr√°fico el RMSE, CORRELACION Y DESVIACI√ìN ESTANDAR 

## SIN FILTRADO

```{r eval=TRUE, fig.height=6, fig.width=6}
library(plotrix)
library(DescTools)

 taylor.diagram(as.vector(DATOS_PLOT$WS_N), 
                 as.vector(DATOS_PLOT$WS_N))

 taylor.diagram(as.vector(DATOS_PLOT$WS_N), 
                 as.vector(DATOS_PLOT$ERAWS),add = TRUE)
  
```

## FILTRANDO POR DIRECCIONES AGRUPADAS

### FILTRANDO POR DIRECCIONES ANEMOMETRO

```{r eval=TRUE, fig.height=6, fig.width=6}
#FILTRADO POR DIRECCIONES
West<- c(247.5,270.0,292.5)
North_west<-c(292.5,315.0,337.5)
South_west<- c(202.5, 225.0, 247.5)
North<- c(0.0,22.5,337.5)
North_east<- c(22.5,45.0,67.5)
East<- c(67.5,90,112.5)
South_east<- c(112.5,135.0,157.5)
South<- c(157.5,180.0, 202.5)

lista_dir<- list(W=West,NW= North_west,N= North, NE=North_east, 
     E=East, SE=South_east,S=South, SW=South_west)


tabla_taylor<- matrix(ncol = 5, nrow = length(lista_dir)) %>% as.data.frame()
for (i in 1:length(lista_dir)) {
  DATOS_PLOT_fil<- DATOS_PLOT %>% filter(WD_N%in%lista_dir[[i]]) %>%
    .[complete.cases(.),]
  
  if (i==1) {taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                   as.vector(DATOS_PLOT_fil$WS_N), col = i)}else{
                     taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                                    as.vector(DATOS_PLOT_fil$WS_N), col = i, add = TRUE)
                   }
  
  taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                 as.vector(DATOS_PLOT_fil$ERAWS),add = TRUE,col = i)
  
  tabla_taylor[i,1]<- cor(DATOS_PLOT_fil$ERAWS,
                          DATOS_PLOT_fil$WS_N)
  tabla_taylor[i,2]<- sd(DATOS_PLOT_fil$ERAWS,
                          DATOS_PLOT_fil$WS_N)
  tabla_taylor[i,3]<- RMSE(DATOS_PLOT_fil$ERAWS,
                         DATOS_PLOT_fil$WS_N,na.rm = TRUE)
  tabla_taylor[i,4]<- MAPE(DATOS_PLOT_fil$WS_N,
                           DATOS_PLOT_fil$ERAWS, na.rm = TRUE)
  tabla_taylor[i,5]<- length(DATOS_PLOT_fil$WS_N)
}


colnames(tabla_taylor)<- c("Corr", "SD", "RMSE", "MAPE", "Cases")
rownames(tabla_taylor)<- names(lista_dir)

tabla_taylor$prctj_cases<- (tabla_taylor$Cases/(tabla_taylor$Cases %>% sum()))*100
# get approximate legend position
lpos<-2*sd(DATOS_PLOT_fil$WS_N)
# add a legend
legend(lpos-0.3,lpos-0.7,legend=paste0(names(lista_dir),
                                       " (",
                                       tabla_taylor$prctj_cases %>% round(),
                                       " %)"),
       pch=19,col=seq(1,length(lista_dir), by=1))


library(knitr)
kable(tabla_taylor[order(tabla_taylor$Corr, decreasing = TRUE),])

```

### FILTRANDO POR DIRECCIONES ERA5

```{r eval=TRUE, fig.height=6, fig.width=6}
#filtrando por ERA5
#filtrando por ERA5
West<- c(247.5,270.0,292.5)
North_west<-c(292.5,315.0,337.5)
South_west<- c(202.5, 225.0, 247.5)
North<- c(0.0,22.5,337.5)
North_east<- c(22.5,45.0,67.5)
East<- c(67.5,90,112.5)
South_east<- c(112.5,135.0,157.5)
South<- c(157.5,180.0, 202.5)

lista_dir<- list(W=West,NW= North_west,N= North, NE=North_east, 
     E=East, SE=South_east,S=South, SW=South_west)
tabla_taylorERA<- matrix(ncol = 5, nrow = length(lista_dir)) %>% as.data.frame()
for (i in 1:length(lista_dir)) {
  DATOS_PLOT_fil<- DATOS_PLOT %>% filter(ERA_binDir%in%lista_dir[[i]]) %>%
    .[complete.cases(.),]
  
  if (i==1) {taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                            as.vector(DATOS_PLOT_fil$WS_N), col = i)}else{
                              taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                                             as.vector(DATOS_PLOT_fil$WS_N), col = i, add = TRUE)
                            }
  
  taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                 as.vector(DATOS_PLOT_fil$ERAWS),add = TRUE,col = i)
  
  tabla_taylorERA[i,1]<- cor(DATOS_PLOT_fil$ERAWS,
                          DATOS_PLOT_fil$WS_N)
  tabla_taylorERA[i,2]<- sd(DATOS_PLOT_fil$ERAWS,
                         DATOS_PLOT_fil$WS_N)
  tabla_taylorERA[i,3]<- RMSE(DATOS_PLOT_fil$ERAWS,
                           DATOS_PLOT_fil$WS_N,na.rm = TRUE)
  tabla_taylorERA[i,4]<- MAPE(DATOS_PLOT_fil$WS_N,
                           DATOS_PLOT_fil$ERAWS, na.rm = TRUE)
  tabla_taylorERA[i,5]<- length(DATOS_PLOT_fil$WS_N)
}


colnames(tabla_taylorERA)<- c("Corr", "SD", "RMSE", "MAPE", "Cases")
rownames(tabla_taylorERA)<- names(lista_dir)

tabla_taylorERA$prctj_cases<- (tabla_taylorERA$Cases/(tabla_taylorERA$Cases %>% sum()))*100
# get approximate legend position
lpos<-2*sd(DATOS_PLOT_fil$WS_N)
# add a legend
legend(lpos,lpos-0.7,legend=paste0(names(lista_dir),
                                       " (",
                                       tabla_taylorERA$prctj_cases %>% round(),
                                       " %)"),
       pch=19,col=seq(1,length(lista_dir), by=1))



kable(tabla_taylorERA[order(tabla_taylorERA$Corr, decreasing = TRUE),])


```


```{r eval=FALSE}
### COMPARANDO RESULTADOS

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$Corr), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$Corr),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$Corr), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$Corr),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("Correlation")+
  ggtitle("ERA5 (RED) Vs ANEMOMETER (BLUE)")+
  theme_light()

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$SD), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$SD),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$SD), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$SD),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("SD")+
  theme_light()

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$RMSE), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$RMSE),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$RMSE), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$RMSE),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("RMSE")+
  theme_light()

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$MAPE), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$MAPE),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$MAPE), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$MAPE),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("MAPE")+
  theme_light()
ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$Cases), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$Cases),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$Cases), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$Cases),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("CASES")+
  theme_light()
```



```{r eval=FALSE, fig.height=6, fig.width=6}
## FILTRANDO POR DIRECCIONES SIN AGRUPAR

### FILTRANDO POR ANEMOMETRO

######filtrando por anemometro
lista_dir<- DATOS_PLOT %>% group_split(WD_N) %>% lapply(function(x){
  r<- cbind(x$WD_N %>% unique, sd(x$ERAWS, na.rm = TRUE)) %>% as.data.frame()
  colnames(r)<- c("Dir", "SD")
  return(r)
}) %>% bind_rows() %>% .[order(.$SD, decreasing = T), 1]
tabla_taylor<- matrix(ncol = 5, nrow = length(lista_dir)) %>% as.data.frame()


for (i in 1:length(lista_dir)) {
  DATOS_PLOT_fil<- DATOS_PLOT %>% filter(WD_N%in%lista_dir[[i]]) %>%
    .[complete.cases(.),]
  
  if (i==1) {taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                            as.vector(DATOS_PLOT_fil$WS_N), 
                            col = i,
                            pch = i)}else{
                              taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                                             as.vector(DATOS_PLOT_fil$WS_N),
                                             col = i, 
                                             add = TRUE,
                                             pch = i)
                            }
  
  taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                 as.vector(DATOS_PLOT_fil$ERAWS),
                 add = TRUE,col = i,
                 pch = i)
  
  tabla_taylor[i,1]<- cor(DATOS_PLOT_fil$ERAWS,
                             DATOS_PLOT_fil$WS_N)
  tabla_taylor[i,2]<- sd(DATOS_PLOT_fil$ERAWS,
                            DATOS_PLOT_fil$WS_N)
  tabla_taylor[i,3]<- RMSE(DATOS_PLOT_fil$ERAWS,
                              DATOS_PLOT_fil$WS_N,na.rm = TRUE)
  tabla_taylor[i,4]<- MAPE(DATOS_PLOT_fil$WS_N,
                              DATOS_PLOT_fil$ERAWS, na.rm = TRUE)
  tabla_taylor[i,5]<- length(DATOS_PLOT_fil$WS_N)
}

# get approximate legend position
lpos<-2*sd(DATOS_PLOT_fil$WS_N)
# add a legend
legend(lpos+0.6,lpos+0.3,legend=lista_dir %>% as.character(),
       pch=1:length(lista_dir),col=1:length(lista_dir))


colnames(tabla_taylor)<- c("Corr", "SD", "RMSE", "MAPE", "Cases")
rownames(tabla_taylor)<- lista_dir %>% as.character()
kable(tabla_taylor[order(tabla_taylor$Corr, decreasing = TRUE),])



```

```{r eval=FALSE, fig.height=6, fig.width=6}
### FILTRANDO POR ERA5

#filtrando por ERA5
lista_dir<- DATOS_PLOT %>% group_split(WD_N) %>% lapply(function(x){
  r<- cbind(x$WD_N %>% unique, sd(x$ERAWS, na.rm = TRUE)) %>% as.data.frame()
  colnames(r)<- c("Dir", "SD")
  return(r)
}) %>% bind_rows() %>% .[order(.$SD, decreasing = T), 1]

tabla_taylorERA<- matrix(ncol = 5, nrow = length(lista_dir)) %>% as.data.frame()

for (i in 1:length(lista_dir)) {
  DATOS_PLOT_fil<- DATOS_PLOT %>% filter(ERA_binDir%in%lista_dir[[i]]) %>%
    .[complete.cases(.),]
  
  if (i==1) {taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                            as.vector(DATOS_PLOT_fil$WS_N), 
                            col = i,
                            pch = i)}else{
                              taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                                             as.vector(DATOS_PLOT_fil$WS_N),
                                             col = i, 
                                             add = TRUE,
                                             pch = i)
                            }
  
  taylor.diagram(as.vector(DATOS_PLOT_fil$WS_N), 
                 as.vector(DATOS_PLOT_fil$ERAWS),
                 add = TRUE,col = i,
                 pch = i)
  
  tabla_taylorERA[i,1]<- cor(DATOS_PLOT_fil$ERAWS,
                             DATOS_PLOT_fil$WS_N)
  tabla_taylorERA[i,2]<- sd(DATOS_PLOT_fil$ERAWS,
                            DATOS_PLOT_fil$WS_N)
  tabla_taylorERA[i,3]<- RMSE(DATOS_PLOT_fil$ERAWS,
                              DATOS_PLOT_fil$WS_N,na.rm = TRUE)
  tabla_taylorERA[i,4]<- MAPE(DATOS_PLOT_fil$WS_N,
                              DATOS_PLOT_fil$ERAWS, na.rm = TRUE)
  tabla_taylorERA[i,5]<- length(DATOS_PLOT_fil$WS_N)
}

# get approximate legend position
lpos<-2*sd(DATOS_PLOT_fil$WS_N)
# add a legend
legend(lpos+0.6,lpos+0.8,legend=lista_dir %>% as.character(),
       pch=1:length(lista_dir),col=1:length(lista_dir))


colnames(tabla_taylorERA)<- c("Corr", "SD", "RMSE", "MAPE", "Cases")
rownames(tabla_taylorERA)<- lista_dir %>% as.character()
kable(tabla_taylorERA[order(tabla_taylorERA$Corr, decreasing = TRUE),])


```

```{r eval=FALSE}
### COMPARANDO RESULTADOS

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$Corr), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$Corr),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$Corr), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$Corr),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("Correlation")+
  ggtitle("ERA5 (RED) Vs ANEMOMETER (BLUE)")+
  theme_light()

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$SD), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$SD),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$SD), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$SD),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("SD")+
  theme_light()

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$RMSE), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$RMSE),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$RMSE), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$RMSE),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("RMSE")+
  theme_light()

ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$MAPE), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$MAPE),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$MAPE), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$MAPE),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("MAPE")+
  theme_light()
ggplot()+
  geom_histogram(aes(x=row.names(tabla_taylor),
                     y=tabla_taylor$Cases), 
                 stat = "identity",
                 fill= "blue",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylor$Cases),
                x=1:nrow(tabla_taylor)),
            col="blue",
            linetype= "longdash")+
  geom_histogram(aes(x=row.names(tabla_taylorERA),
                     y=tabla_taylorERA$Cases), 
                 stat = "identity",
                 fill= "red",
                 alpha=0.5)+
  geom_line(aes(y=mean(tabla_taylorERA$Cases),
                x=1:nrow(tabla_taylorERA)),
            col="red",
            linetype= "longdash")+
  xlab("Wind direction")+
  ylab("CASES")+
  theme_light()
```

# CONCLUSIONES SEGUNDA FASE

Tras la elaboraci√≥n de los diagramas de taylor podemos ver como tras realizar un filtrado de los datos por direcciones se consigue una mejora en los resultados. Tambien es apreciable que filtrando los datos por direcciones indicadas del ERA5 se consigue mejorar la correlaci√≥n y disminuir el RMSE y el MAPE. 

Lo siguiente que haremos ser√° realizar la calibraci√≥n quantile-mapping empleando el paquete **qmap** y volver a realizar todos los diagramas de taylor y las distribuciones de weibull, esperando obtener una mejora en el bias. 



# QUANTILE MAPPING

A continuaci√≥n se empezar√°n a presentar las pruebas realizadas para realizar la calibraci√≥n del bias. Las siguientes pruebas se realizar√°n aplicando primero t√©cnicas m√°s b√°sicas y posteriormente m√©todos m√°s complejos. Las gr√°ficas que se presentan a continuacion tienen "trampita", es decir, estamos "entrenando" la funcion de transferencia y aplicando la misma al mismo vector. 


```{r eval=TRUE, results='hide',fig.keep='all'}

DATA_FOLDERS<- list.dirs(here::here('NUEVO/Data_calibracion/'), recursive = F)

ERA5_FILES<-  DATA_FOLDERS[1] %>% list.files(full.names = T) %>% 
  .[str_detect(., "ERA5")]

DATES_FILES<- ERA5_FILES %>% sapply(function(x){
  filename<- str_split(x, '/') %>% .[[1]] %>% .[length(.)]
  date_filename<- str_replace(filename, 'ERA5_', '') %>% str_replace(. , '.RDS','') %>% ymd()
  date_filename
})


DATOS_JUNTOS<- ERA5_FILES[which.max(DATES_FILES)] %>% readRDS()


DATOS_JUNTOS_LISTA<- DATOS_JUNTOS %>% group_split(ERAlon,ERAlat)

#CALCULAMOS DISTANCIAS ENTRE ERA5 Y ANEMOMETRO
DISTANCIA_ERA5_ANEMO<- DATOS_JUNTOS_LISTA %>% sapply(function(x){distm(c(x$ERAlon[1], x$ERAlat[1]), c(x$lon[1],x$lat[1]))})


#SACAMOS EL PUNTO M√ÅS CERCANO Y TRABAJAMOS DESDE AQU√ç. 
PUNTO_MC<- DATOS_JUNTOS_LISTA[[which.min(DISTANCIA_ERA5_ANEMO)]]  %>%
  mutate(ERA_binDir= cut(ERAWD ,
                         breaks =c(0,seq(22.5,337.5,22.5),360, 361), 
                         labels = c(0,seq(22.5,337.5,22.5),0) %>% as.factor()))
PUNTO_MC$ERA_binDir<- PUNTO_MC$ERA_binDir %>% as.character() %>% as.numeric()
PUNTO_MC$WD_N<- ifelse(PUNTO_MC$WD_N==155, 157.5, PUNTO_MC$WD_N) 



#CALIBRACION QMAP
library(qmap)
library(forecast)
#SACAMOS LA FUNCION DE TRANSFERENCIA
PUNTO_MC<- PUNTO_MC %>%  .[complete.cases(.),]
ftrans=fitQmapQUANT(PUNTO_MC$WS_N,PUNTO_MC$ERAWS)

#CALIBRAMOS Y SACAMOS WEIBULL DE NUEVO
calibrado=doQmapQUANT(PUNTO_MC$ERAWS,ftrans)

PUNTO_MC$CALIB<- calibrado

DATOS_weibull1<- WEIBULL_PLOT(PUNTO_MC, CALIBRATED = TRUE)


ggplot(data = DATOS_weibull1 %>%  filter(month(Date)==2, week(Date)==6)) + 
  geom_line(aes(x= Date,
                y= ERAWS), col="red")+
  geom_line(aes(x= Date,
                y= WS_N), col="blue", alpha= 0.4)+
  geom_line(aes(x= Date,
                y= CALIB), col="darkgreen") + 
  theme_light() + 
  ylab("Wind Speed (m/s)")+
  ggtitle("Demostration of bias-correction using Quantile mapping")

```

```{r eval=TRUE, fig.height=6, fig.width=6}
 taylor.diagram(as.vector(DATOS_weibull1$WS_N), 
                 as.vector(DATOS_weibull1$WS_N),col = "blue")

 taylor.diagram(as.vector(DATOS_weibull1$WS_N), 
                 as.vector(DATOS_weibull1$ERAWS),add = TRUE, col = "red")
 taylor.diagram(as.vector(DATOS_weibull1$WS_N), 
                 as.vector(DATOS_weibull1$CALIB),add = TRUE, col= "darkgreen")
 
 lpos<-1.5*sd(DATOS_weibull1$WS_N)
# add a legend
legend(lpos-0.3,lpos,legend=c('ERA5 sin calibrar',
                              'ERA5 calibrado'),
       pch = 19,
       col=c('red', 'darkgreen'))
```



```{r eval=TRUE, results='hide',fig.keep='all'}
lista_total_ERA<- here::here('NUEVO/Data_ERA5/Lista_ERA5_Total.RDS') %>% readRDS()


TABLA_TOTAL_ERA5<- lista_total_ERA %>% bind_rows()


calibrado_total=doQmapQUANT(TABLA_TOTAL_ERA5$uv_wind %>% na.omit(),ftrans)



DATOS_weibull1_T<- WEIBULL_PLOT(PUNTO_MC, CALIBRATED = TRUE, 
                                TOTAL_VECTOR = calibrado_total,
                                ACUMULATED = TRUE)


```

Se puede ver, que el quantile mapping consigue sobre todo mejorar el bias, pero la correlaci√≥n se mantiene constante. Esto se ve claramente en el diagrama de taylor. El punto verde representa la serie calibrada mediante quantile mapping. Presenta un error menor que la serie original (rojo). 


Ahora, lo que vamos a hacer es:  entrenar y aplicar la funcion de transferencia a diferentes muestras... para poder observar como se comporta el quantile mapping. 


Entrenamos la funci√≥n de transferencia con la mitad de los datos... (6700/2)

```{r  eval=TRUE, results='hide',fig.keep='all'}
PUNTO_MC<- PUNTO_MC %>%  .[complete.cases(.),]

GRUPO_ENTRENAMIENTO<- PUNTO_MC[1:(nrow(PUNTO_MC)/2), ]
GRUPO_TEST<-  PUNTO_MC[((nrow(PUNTO_MC)/2):nrow(PUNTO_MC)), ]



ftrans=fitQmapQUANT(GRUPO_ENTRENAMIENTO$WS_N,
                    GRUPO_ENTRENAMIENTO$ERAWS)

#CALIBRAMOS Y SACAMOS WEIBULL DE NUEVO
calibrado=doQmapQUANT(GRUPO_TEST$ERAWS,ftrans)

GRUPO_TEST$CALIB<- calibrado


DATOS_weibull2<- WEIBULL_PLOT(GRUPO_TEST, CALIBRATED = TRUE)


ggplot(data = DATOS_weibull2 %>%  filter(month(Date)==2, week(Date)==6)) + 
  geom_line(aes(x= Date,
                y= ERAWS), col="red")+
  geom_line(aes(x= Date,
                y= WS_N), col="blue", alpha= 0.4)+
  geom_line(aes(x= Date,
                y= CALIB), col="darkgreen") + 
  theme_light() + 
  ylab("Wind Speed (m/s)")+
  ggtitle("Demostration of bias-correction using Quantile mapping")


 


```

```{r  eval=TRUE, fig.height=6, fig.width=6}
taylor.diagram(as.vector(DATOS_weibull2$WS_N), 
                 as.vector(DATOS_weibull2$WS_N),col = "blue")

 taylor.diagram(as.vector(DATOS_weibull2$WS_N), 
                 as.vector(DATOS_weibull2$ERAWS),add = TRUE, col = "red")
 taylor.diagram(as.vector(DATOS_weibull2$WS_N), 
                 as.vector(DATOS_weibull2$CALIB),add = TRUE, col= "darkgreen")

```


Se aprecia claramente como en este caso, el ajuste y la mejora conseguida con el quantile-mapping no es tan acusado. 



A continuaci√≥n ponemos a prueba la influencia de la longitud del grupo de entrenamiento

```{r eval=TRUE, fig.height=6, fig.width=6}

PUNTO_MC<- PUNTO_MC %>%  .[complete.cases(.),]
GRUPO_TEST<-  PUNTO_MC[((nrow(PUNTO_MC)-1000):nrow(PUNTO_MC)), ]


LENGTH_TRAIN<- vector()
k<- 1
for (i in c(8,6,4,2,1)) {
  if(k==1){
    taylor.diagram(as.vector(GRUPO_TEST$WS_N), 
                 as.vector(GRUPO_TEST$WS_N),col = "red")
  }
  
  GRUPO_ENTRENAMIENTO<- PUNTO_MC[1:((nrow(PUNTO_MC)-1000)/i), ]

LENGTH_TRAIN[k]<- 1:((nrow(PUNTO_MC)-1000)/i) %>% length()
k<- k+1

ftrans=fitQmapQUANT(GRUPO_ENTRENAMIENTO$WS_N,
                    GRUPO_ENTRENAMIENTO$ERAWS)

#CALIBRAMOS Y SACAMOS WEIBULL DE NUEVO
calibrado=doQmapQUANT(GRUPO_TEST$ERAWS,ftrans)

GRUPO_TEST$CALIB<- calibrado

 taylor.diagram(as.vector(GRUPO_TEST$WS_N), 
                 as.vector(GRUPO_TEST$CALIB),add = TRUE, col= i)


}



lpos<-1.4*sd(GRUPO_TEST$WS_N)
# add a legend
legend(lpos+0.2,lpos-0.7,legend=LENGTH_TRAIN,
       pch=19,col= c(8,6,4,2,1))
```


# FUNCIONES DE TRANSFERENCIA POR DIRECCIONES 
A continuaci√≥n realizamos un ejercicio aplicando el quantile mapping por direcciones... de esta manera se pretende crear 16 funciones de transferencia que nos permitan obtener una predicci√≥n m√°s ajustada. 

## FUNCIONES DE TRANSFERENCIA PARA CADA DIRECCION (16 direcciones)

Para este ejercicio creamos una funcion de transferencia para cada direccion del ERA5


```{r eval=TRUE}
PUNTO_MC<- PUNTO_MC %>%  .[complete.cases(.),]

GRUPO_ENTRENAMIENTO<- PUNTO_MC[1:(nrow(PUNTO_MC)/2), ]
GRUPO_TEST<-  PUNTO_MC[((nrow(PUNTO_MC)/2):nrow(PUNTO_MC)), ]



LISTA_ENTRENAMIENTO<- GRUPO_ENTRENAMIENTO %>% group_split(ERA_binDir)

Vector_dir<- LISTA_ENTRENAMIENTO %>% sapply(function(x) x$ERA_binDir %>% unique())

names(LISTA_ENTRENAMIENTO)<- Vector_dir

LISTA_FTRANS<- list()
for (i in 1:length(LISTA_ENTRENAMIENTO)) {
  TRAIN<- LISTA_ENTRENAMIENTO[[i]]
  LISTA_FTRANS[[names(LISTA_ENTRENAMIENTO)[i]]]=fitQmapQUANT(TRAIN$WS_N,
                                 TRAIN$ERAWS)
  
}


#APLICAMOS LAS FUNCIONES DE TRANSFERENCIA POR DIRECCION
LISTA_TEST<- GRUPO_TEST %>% group_split(ERA_binDir)
Vector_dir<- LISTA_TEST %>% sapply(function(x) x$ERA_binDir %>% unique())
names(LISTA_TEST)<- Vector_dir


for (i in 1:length(LISTA_TEST)) {
  calibrado=doQmapQUANT(LISTA_TEST[[i]]$ERAWS,LISTA_FTRANS[[i]])
  LISTA_TEST[[i]]$CALIB<- calibrado
  
}


#JUNTAMOS DE NUEVO EN FORMATO TABLA Y LA ORDENAMOS CRONOL√ìGICAMENTE. A CONTINUACI√ìN PROBAMOS
MERGE_TEST<- LISTA_TEST %>% bind_rows() %>% .[order(.$Date),]

```

```{r eval=TRUE, fig.height=6, fig.width=6}
DATOS_weibull3<-  WEIBULL_PLOT(MERGE_TEST, CALIBRATED = TRUE)


ggplot(data = DATOS_weibull3 %>%  filter(month(Date)==2, week(Date)==6)) + 
  geom_line(aes(x= Date,
                y= ERAWS), col="red")+
  geom_line(aes(x= Date,
                y= WS_N), col="blue", alpha= 0.4)+
  geom_line(aes(x= Date,
                y= CALIB), col="darkgreen") + 
  theme_light() + 
  ylab("Wind Speed (m/s)")+
  ggtitle("Demostration of bias-correction using Quantile mapping")
```

```{r  eval=TRUE, fig.height=6, fig.width=6}
taylor.diagram(as.vector(DATOS_weibull3$WS_N), 
                 as.vector(DATOS_weibull3$WS_N),
               col = "blue",
               main = 'Taylor Diagram 16 transfer functions')

 taylor.diagram(as.vector(DATOS_weibull3$WS_N), 
                 as.vector(DATOS_weibull3$ERAWS),add = TRUE, col = "red")
 taylor.diagram(as.vector(DATOS_weibull3$WS_N), 
                 as.vector(DATOS_weibull3$CALIB),add = TRUE, col= "darkgreen")
  taylor.diagram(as.vector(DATOS_weibull2$WS_N), 
                 as.vector(DATOS_weibull2$CALIB),add = TRUE, col= "purple")
  
lpos<-1.4*sd(DATOS_weibull2$WS_N)
# add a legend
legend(lpos-0.1 ,lpos-0.2,legend=c("ERA5 w/o Cal",
                                  "ERA5 Dir Cal",
                                  "ERA5 NO Dir Cal"),
       pch=19,col= c("red", "darkgreen", "purple"))

```

Se puede observar como no existe una mejora notable respecto al caso anterior en el que se creaba una unica funci√≥n de transferencia. Por lo tanto pasamos a evaluar otras manera de agrupar. De hecho se puede apreciar un empeoramiento en la correlacion. 


## FUNCIONES DE TRANSFERENCIA POR DIRECCION (8 direcciones)

```{r, fig.height=6, fig.width=6}
PUNTO_MC<- PUNTO_MC %>%  .[complete.cases(.),]

GRUPO_ENTRENAMIENTO<- PUNTO_MC[1:(nrow(PUNTO_MC)/2), ]
GRUPO_TEST<-  PUNTO_MC[((nrow(PUNTO_MC)/2):nrow(PUNTO_MC)), ]



LISTA_ENTRENAMIENTO<- GRUPO_ENTRENAMIENTO %>% group_split(ERA_binDir)
LISTA_ENTRENAMIENTO8<- list()
k<- 1
for (i in c(1,3,5,7,9,11,13,15)) {
  LISTA_ENTRENAMIENTO8[[k]]<- bind_rows(LISTA_ENTRENAMIENTO[[i]], LISTA_ENTRENAMIENTO[[i+1]]) %>% .[order(.$Date), ]
  k<- k+1
  }

LISTA_FTRANS<- list()
for (i in 1:length(LISTA_ENTRENAMIENTO8)) {
  
  LISTA_FTRANS[[i]]=fitQmapQUANT(LISTA_ENTRENAMIENTO8[[i]]$WS_N,
                                 LISTA_ENTRENAMIENTO8[[i]]$ERAWS)
  
}


#APLICAMOS LAS FUNCIONES DE TRANSFERENCIA POR DIRECCION
LISTA_TEST<- GRUPO_TEST %>% group_split(ERA_binDir)

LISTA_TEST8<- list()
k<- 1
for (i in c(1,3,5,7,9,11,13,15)) {
  LISTA_TEST8[[k]]<- bind_rows(LISTA_TEST[[i]], LISTA_TEST[[i+1]]) %>% .[order(.$Date), ]
  k<- k+1
}

for (i in 1:length(LISTA_TEST8)) {
  calibrado=doQmapQUANT(LISTA_TEST8[[i]]$ERAWS,LISTA_FTRANS[[i]])
  LISTA_TEST8[[i]]$CALIB<- calibrado
  
}


#JUNTAMOS DE NUEVO EN FORMATO TABLA Y LA ORDENAMOS CRONOL√ìGICAMENTE. A CONTINUACI√ìN PROBAMOS
MERGE_TEST<- LISTA_TEST8 %>% bind_rows() %>% .[order(.$Date),]
```

```{r eval=TRUE}
DATOS_weibull8<- WEIBULL_PLOT(MERGE_TEST, CALIBRATED = TRUE)


ggplot(data = DATOS_weibull8 %>%  filter(month(Date)==2, week(Date)==6)) + 
  geom_line(aes(x= Date,
                y= ERAWS), col="red")+
  geom_line(aes(x= Date,
                y= WS_N), col="blue", alpha= 0.4)+
  geom_line(aes(x= Date,
                y= CALIB), col="darkgreen") + 
  theme_light() + 
  ylab("Wind Speed (m/s)")+
  ggtitle("Demostration of bias-correction using Quantile mapping")
```

```{r eval=TRUE, fig.height=6, fig.width=6}
taylor.diagram(as.vector(DATOS_weibull3$WS_N), 
                 as.vector(DATOS_weibull3$WS_N),
               col = "blue",
               main = 'Taylor Diagram 16 transfer functions')

 taylor.diagram(as.vector(DATOS_weibull3$WS_N), 
                 as.vector(DATOS_weibull3$ERAWS),add = TRUE, col = "red")
 taylor.diagram(as.vector(DATOS_weibull3$WS_N), 
                 as.vector(DATOS_weibull3$CALIB),add = TRUE, col= "darkgreen")
  taylor.diagram(as.vector(DATOS_weibull2$WS_N), 
                 as.vector(DATOS_weibull2$CALIB),add = TRUE, col= "purple")
    taylor.diagram(as.vector(DATOS_weibull8$WS_N), 
                 as.vector(DATOS_weibull8$CALIB),add = TRUE, col= "orange")
  
lpos<-1.4*sd(DATOS_weibull2$WS_N)
# add a legend
legend(lpos-0.1 ,lpos-0.2,legend=c("ERA5 w/o Cal",
                                  "ERA5 Dir Cal 16",
                                  "ERA5 NO Dir Cal",
                                   "ERA5 Dir Cal 8"),
       pch=19,col= c("red", "darkgreen", "purple", "orange"))

```

